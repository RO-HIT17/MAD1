<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start the Quiz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='startquiz.css') }}">
</head>
<body>
    <div class="quiz-container">
        <h2>Start the Quiz</h2>

        <!-- Timer and Question Number -->
        <div class="quiz-header">
            <div class="qno-box">QNo. <span id="qno-box">1/{{ questions|length }}</span></div>
            
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar"></div>
        </div>

        <!-- Question Statement -->
        <div class="question-box">
            <p id="question-text">Loading question...</p>
        </div>

        <!-- Options -->
        <form class="options">
            <label><input type="radio" name="option" value="1"> <span id="option1"></span></label>
            <label><input type="radio" name="option" value="2"> <span id="option2"></span></label>
            <label><input type="radio" name="option" value="3"> <span id="option3"></span></label>
            <label><input type="radio" name="option" value="4"> <span id="option4"></span></label>
        </form>

        <!-- Buttons -->
        <div class="buttons">
            <button onclick="nextQuestion()" class="save-next">Save & Next</button>
            <button onclick="submitQuiz()" class="submit">Submit</button>
        </div>
    </div>

    <script>
        let currentQuestionIndex = 0;
        let questions = {{ questions | tojson }};
        let userAnswers = JSON.parse(localStorage.getItem("userAnswers")) || {};
        let duration = "{{ quiz.time_duration }}"; // Format: "HH:MM"
        let timerElement = document.getElementById("timer");
        let progressBar = document.getElementById("progress-bar");

        function startTimer() {
            let [hours, minutes] = duration.split(":").map(Number);
            let totalSeconds = hours * 3600 + minutes * 60; // Convert to total seconds
        
            function updateTimer() {
                if (totalSeconds <= 0) {
                    timerElement.innerText = "00:00";
                    timerElement.style.color = "red"; // Ensure it's red at timeout
                    clearInterval(interval);
                    submitQuiz(); // Auto-submit when time runs out
                    return;
                }
        
                let mins = Math.floor(totalSeconds / 60);
                let secs = totalSeconds % 60;
                timerElement.innerText = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        
                // Flash red when 10 seconds left
                if (totalSeconds <= 10) {
                    timerElement.style.color = totalSeconds % 2 === 0 ? "red" : "black";
                } else {
                    timerElement.style.color = ""; // Reset to default
                }
        
                totalSeconds--; // Decrease AFTER updating display
            }
        
            updateTimer(); // Initial call to prevent 1-sec delay
            let interval = setInterval(updateTimer, 1000);
        }
        

        function loadQuestion() {
            let question = questions[currentQuestionIndex];
            document.getElementById("qno-box").innerText = `${currentQuestionIndex + 1}/${questions.length}`;
            document.getElementById("question-text").innerText = question.question_statement;
            document.getElementById("option1").innerText = question.option1;
            document.getElementById("option2").innerText = question.option2;
            document.getElementById("option3").innerText = question.option3 || "";
            document.getElementById("option4").innerText = question.option4 || "";

            progressBar.style.width = `${((currentQuestionIndex + 1) / questions.length) * 100}%`;
        }

        function nextQuestion() {
            let selectedOption = document.querySelector('input[name="option"]:checked');
            if (selectedOption) {
                userAnswers[questions[currentQuestionIndex].id] = selectedOption.value;
                localStorage.setItem("userAnswers", JSON.stringify(userAnswers));
            } else {
                alert("Please select an answer before moving to the next question.");
                return;
            }

            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                alert("Last question reached! Click Submit.");
            }
        }

        function submitQuiz() {
            if (!confirm("Are you sure you want to submit the quiz?")) return;

            fetch("/submit_quiz", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ quiz_id: {{ quiz.id }}, answers: userAnswers })
            })
            .then(response => response.json())
            .then(data => {
                alert(`ðŸŽ‰ Quiz Submitted! Your Score: ${data.score}`);
                localStorage.removeItem("userAnswers");
                window.location.href = "/user_dashboard"; 
            });
        }

        window.onload = function () {
            loadQuestion();
            startTimer();
        };
    </script>
</body>
</html>
